{% if global_notes %}
  <div class="mb-3 rounded border border-slate-800 bg-slate-950/60 p-3 text-sm text-slate-200">
    <div class="text-xs uppercase tracking-wide text-slate-400">AI notes</div>
    <div class="mt-1 whitespace-pre-wrap">{{ global_notes }}</div>
  </div>
{% endif %}

<div class="mb-4 rounded border border-slate-800 bg-slate-950/40 p-3">
  <div class="flex items-center justify-between gap-4">
    <div class="text-sm font-medium">Timeline scrub</div>
    <div class="text-xs text-slate-400">
      showing events up to: <span class="text-slate-200">{{ t_value }}</span>
    </div>
  </div>
  <input
    name="t"
    type="range"
    min="{{ t_min }}"
    max="{{ t_max }}"
    value="{{ t_value }}"
    class="mt-2 w-full"
    hx-get="/timeline/events/list"
    hx-target="#event-table"
    hx-swap="innerHTML"
    hx-trigger="input changed delay:50ms"
    hx-include="#timeline-filter"
  />

  <div class="mt-4">
    <div class="relative h-10 rounded bg-slate-900/40 border border-slate-800 overflow-hidden">
      <div class="absolute left-0 right-0 top-1/2 h-px bg-slate-700"></div>
      {% for p in timeline %}
        <div
          class="absolute top-1/2 -translate-y-1/2"
          data-lk-pct="{{ p.pct }}"
          title="{{ p.order }} â€” {{ p.event.title }}"
        >
          <div class="h-3 w-3 -translate-x-1/2 rounded-full bg-indigo-500 ring-2 ring-indigo-500/30"></div>
        </div>
      {% endfor %}
    </div>
    <div class="mt-1 flex justify-between text-[11px] text-slate-500">
      <span>{{ t_min }}</span>
      <span>{{ t_max }}</span>
    </div>
  </div>
</div>

{% if events|length == 0 %}
  <div class="text-sm text-slate-400">No events match your filters yet.</div>
{% else %}
  <!-- Vertical Timeline Container -->
  <div class="timeline-container relative pl-8">
    <!-- Vertical line -->
    <div class="absolute left-3 top-0 bottom-0 w-0.5 bg-slate-700"></div>

    <!-- Act headers and event cards -->
    {% set current_act = namespace(value=None) %}
    {% for e in events %}
      {% if e.act != current_act.value %}
        {% set current_act.value = e.act %}
        <!-- Act header divider -->
        <div class="act-divider relative flex items-center py-6">
          <div class="absolute left-3 -translate-x-1/2 h-8 w-8 rounded-full bg-slate-800 border-2 border-indigo-500 flex items-center justify-center">
            <span class="text-xs font-bold text-indigo-300">{{ e.act.split()[-1] if e.act else "?" }}</span>
          </div>
          <div class="ml-12 text-lg font-semibold text-slate-200">{{ e.act or "Unassigned" }}</div>
          <div class="ml-4 flex-1 h-px bg-slate-700"></div>
        </div>
      {% endif %}
      {% set tags = tags_by_id.get(e.id, []) %}
      {% include "partials/event_row.html" %}
    {% endfor %}
  </div>
{% endif %}


